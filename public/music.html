<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Music Player</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { margin: 3px 0; }
    #musicList { list-style: none; padding-left: 0; }
    #searchBox { width: 300px; margin-bottom: 10px; }
    audio { margin-top: 20px; width: 400px; display: block; }
  </style>
</head>
<body>
  <h1>Music Player</h1>
  <button onclick="window.location.href='home.html'">⬅ Back to Home</button>

  <br><br>
  <input type="text" id="searchBox" placeholder="Search music..." oninput="searchMusic()" />

  <audio id="player" controls></audio>

  <ul id="musicList"></ul>

  <script>
    const sessionToken = localStorage.getItem("sessionToken");
    if (!sessionToken) window.location.href = "index.html";

    let allMusic = [];

    async function loadMusic() {
      try {
        const res = await fetch("/api/music", {
          headers: { "Authorization": "Bearer " + sessionToken }
        });

        if (!res.ok) {
          document.getElementById("musicList").innerHTML = "<li>Error loading music</li>";
          return;
        }

        allMusic = await res.json(); // Now the array directly
        renderMusic(allMusic);

      } catch (err) {
        console.error(err);
        document.getElementById("musicList").innerHTML = "<li>Error loading music</li>";
      }
    }

    function renderMusic(musicArray) {
      const list = document.getElementById("musicList");
      list.innerHTML = "";
      musicArray.forEach(file => {
        // Split path into parts
        const parts = file.split(/[\\/]/); // handles both / and \
        const artist = parts.length > 1 ? parts[parts.length - 3] : "Unknown Artist";
        const filename = parts[parts.length - 1];

        // Remove extension
        const songName = filename.replace(/\.[^/.]+$/, "");

        // Optionally remove leading track numbers like "01 "
        const cleanSong = songName.replace(/^\d+\s*/, "");

            // Display as "Artist – Song"
        const displayName = `${artist} – ${cleanSong}`;

        const li = document.createElement("li");
        const btn = document.createElement("button");
        btn.textContent = displayName;
        btn.onclick = () => playMusic(file);
        li.appendChild(btn);
        list.appendChild(li);
      });
    }


    function searchMusic() {
      const term = document.getElementById("searchBox").value.toLowerCase();
      if (term === "") {
        renderMusic(allMusic);
      } else {
        const filtered = allMusic.filter(f => f.toLowerCase().includes(term));
        renderMusic(filtered);
      }
    }

    let currentPlayingLi = null;

    async function playMusic(file) {
      try {
        const res = await fetch("/api/musicfile?file=" + encodeURIComponent(file), {
          headers: { "Authorization": "Bearer " + sessionToken }
        });

        if (!res.ok) {
          alert("Error loading file: " + (await res.text()));
          return;
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const player = document.getElementById("player");
        player.src = url;
        player.play();

        // Highlight current song
        if (currentPlayingLi) currentPlayingLi.style.backgroundColor = "";
        currentPlayingLi = [...document.querySelectorAll("#musicList li button")]
          .find(b => b.onclick.toString().includes(file))?.parentElement;
        if (currentPlayingLi) currentPlayingLi.style.backgroundColor = "#d0f0c0";

      } catch (err) {
        console.error(err);
        alert("Error playing file");
      }
    }

    // Load all music on page load
    loadMusic();
  </script>
</body>
</html>
