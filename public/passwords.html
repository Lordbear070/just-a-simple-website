<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Passwords</title>
  <style>
    body { font-family: Arial; max-width:1000px; margin:20px auto; }
    table { width:100%; border-collapse: collapse; }
    th,td { border:1px solid #ddd; padding:8px; }
    input, textarea { width:100%; }
    .small { width:120px; }
  </style>
</head>
<body>
  <h2>Password Vault</h2>
  <p>Master password is kept in this browser session while you work (not persisted).</p>

  <div>
    <button id="load">Load Vault</button>
    <button id="save">Save Vault</button>
    <button id="newEntry">New Entry</button>
  </div>

  <div id="vaultArea"></div>

  <script>
    function getMaster(){ return sessionStorage.getItem('master'); }

    async function apiPost(url, body){
      const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      return r.json();
    }

    let vault = []; // array of entries

    function render(){
      const area = document.getElementById('vaultArea');
      if (!vault.length) { area.innerHTML = "<p>No entries.</p>"; return; }
      let html = '<table><tr><th>Website</th><th>Username</th><th>Password</th><th>Email</th><th>Phone</th><th>Security Q</th><th>Recovery</th><th>Actions</th></tr>';
      vault.forEach((e,i) => {
        html += `<tr>
          <td><input value="${(e.website||'')}" data-i="${i}" data-field="website"/></td>
          <td><input value="${(e.username||'')}" data-i="${i}" data-field="username"/></td>
          <td><input value="${(e.password||'')}" data-i="${i}" data-field="password"/></td>
          <td><input value="${(e.email||'')}" data-i="${i}" data-field="email"/></td>
          <td><input value="${(e.phone||'')}" data-i="${i}" data-field="phone"/></td>
          <td><input value="${(e.secq||'')}" data-i="${i}" data-field="secq"/></td>
          <td><input value="${(e.recovery||'')}" data-i="${i}" data-field="recovery"/></td>
          <td><button data-i="${i}" class="del">Delete</button></td>
        </tr>`;
      });
      html += '</table>';
      area.innerHTML = html;

      // wire up inputs
      area.querySelectorAll('input').forEach(inp=>{
        inp.onchange = (ev)=>{
          const i = +inp.dataset.i, f = inp.dataset.field;
          vault[i][f] = inp.value;
        };
      });
      area.querySelectorAll('.del').forEach(b=>{
        b.onclick = ()=>{ const i=+b.dataset.i; vault.splice(i,1); render(); };
      });
    }

    document.getElementById('newEntry').onclick = ()=>{
      vault.push({ website:'', username:'', password:'', email:'', phone:'', secq:'', recovery:'' });
      render();
    };

    document.getElementById('load').onclick = async ()=>{
      const master = getMaster();
      if (!master) return alert('Master password missing (login again).');
      const r = await apiPost('/api/passwords/load', { master });
      if (!r.ok) return alert('Load error: ' + (r.error||''));
      vault = r.vault || [];
      render();
    };

    document.getElementById('save').onclick = async ()=>{
      const master = getMaster();
      if (!master) return alert('Master password missing (login again).');
      const r = await apiPost('/api/passwords/save', { master, vault });
      if (!r.ok) return alert('Save error: ' + (r.error||''));
      alert('Saved vault.');
    };

    // auto-load on open
    //document.getElementById('load').click();
  </script>
</body>
</html>
